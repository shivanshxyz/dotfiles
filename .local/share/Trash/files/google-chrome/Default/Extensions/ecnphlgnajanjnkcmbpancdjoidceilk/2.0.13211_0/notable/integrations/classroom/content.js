const KAMI_VIEWER_URL="https://web.kamihq.com";var injectButton=function(){var e=document.querySelector('[role="toolbar"]'),t=document.createElement("div");t.classList.add("kami-drive-viewer-toolstrip-mid-panel"),t.innerHTML='<div class="kami-drive-viewer-toolstrip-open-and-openwith"><a class="kami-drive-viewer-toolstrip-open" role="button" data-tooltip-unhoverable="true" data-tooltip-delay="500" data-tooltip-class="drive-viewer-jfk-tooltip" data-tooltip-align="b,c" data-tooltip-offset="-6" aria-hidden="false" aria-label="Open with Kami" style="user-select: none;" tabindex="0" data-tooltip="Open with Kami"><div class="kami-drive-viewer-open-app-icon"></div><div class="kami-drive-viewer-open-label">Open with Kami</div></a></div>',driveRightButtonsContainerLeftPosition=document.body.offsetWidth-document.querySelector(".ndfHFb-c4YZDc-Wrql6b-AeOLfc-b0t70b").getBoundingClientRect().left,t.style.margin=`4px ${driveRightButtonsContainerLeftPosition}px 0px auto`,e.children[0].appendChild(t),document.querySelector(".kami-drive-viewer-toolstrip-open").addEventListener("click",function(e){wrapWindowOpen();var t=document.querySelector(".ndfHFb-c4YZDc-z5C9Gb-LgbsSe"),n=document.createEvent("MouseEvents");n.initEvent("mousedown",!0,!0),t.dispatchEvent(n),setTimeout(function(){var e=document.querySelector(".ndfHFb-c4YZDc-j7LFlb-Bz112c.ndfHFb-c4YZDc-GSQQnc-LgbsSe").parentElement,t=e.getBoundingClientRect(),n=new MouseEvent("mouseup",{view:window,bubbles:!0,cancelable:!0,clientX:t.left+5,clientY:t.top+5,x:t.left+5,y:t.top+5});e.dispatchEvent(n)},10)})};const parser=document.createElement("div");var wrapWindowOpenScript=function(){/\{\s*\[native code\]\s*\}/.test(""+window.open)&&(window.originalOpen=window.open),window.open=function(){if(window.open=window.originalOpen,0==arguments[0].indexOf("https://drive.google.com/open")){var e=function(e){var t=e.slice(e.indexOf("?"));for(match=void 0,search=/([^&=]+)=?([^&]*)/g,query=t.substring(1),urlParams={};match=search.exec(query);)key=decodeURIComponent(match[1]),value=decodeURIComponent(match[2]),urlParams[key]=value;return urlParams}(arguments[0]);jsonData={ids:[e.id],authuser:e.authuser,from:"classroomopenext"},kamiURL="https://web.kamihq.com/web/viewer.html?state="+encodeURIComponent(JSON.stringify(jsonData)),window.open(kamiURL,"_blank")}else window.open.apply(this,arguments)};var e=document.currentScript;e&&null!==e.parentNode&&e.parentNode.removeChild(e)},wrapWindowOpen=function(){var e=document.head||document.documentElement;if(null===e)return!1;var t=document.createElement("script");t.textContent="("+wrapWindowOpenScript.toString()+")();";try{e.appendChild(t)}catch(e){}},previewOpenObserver=new MutationObserver(function(e){e.forEach(function(e){if(e.addedNodes)for(var t=0;t<e.addedNodes.length;t++){var n=e.addedNodes[t];n.attributes&&n.attributes["aria-label"]&&n.attributes.role&&"dialog"===n.attributes.role.value&&(injectButton(),previewOpenObserver.disconnect())}})}),fetchClassroomAlternateId=function(){var e=window.location.href.match(/https?:\/\/classroom\.google\.com.*\/[cw]\/([A-z0-9]+)/);return e&&e.length>1?e[1]:null},kamiCreateAssignmentButtonListener=function(e){console.log(e),document.body.click(),kamiURL=`${KAMI_VIEWER_URL}/web/viewer.html?open_dialog=create_assignment&seamless_dialog=true&parent_origin=${encodeURIComponent(window.location.origin)}`;var t=fetchClassroomAlternateId();t&&(kamiURL+="&class_alternate_id="+t);var n=`<iframe src="${kamiURL}" seamless="" class="kami-create-assignment-iframe"></iframe>`;parser.innerHTML=n;var a=parser.children[0];parser.removeChild(a);var i=e=>{e.data&&"kami"===e.data.type&&"assignment_dialog_closed"===e.data.event&&(window.removeEventListener("message",i),document.body.removeChild(a))};window.addEventListener("message",i),document.body.appendChild(a)},fabMenuObserver=new MutationObserver(function(e){e.forEach(function(e){if(e.addedNodes)for(var t=0;t<e.addedNodes.length;t++){var n=e.addedNodes[t];(n.attributes&&n.attributes["data-item-type"]&&("assignment"==n.attributes["data-item-type"]||"1"==n.attributes["data-item-type"])||"function"==typeof n.querySelectorAll&&n.querySelectorAll("[data-item-type='assignment'], [data-item-type='1']").length>0)&&injectClassroomKamiAssignmentButton()}})}),injectClassroomKamiAssignmentButton=function(){create_assignment_divs=document.querySelectorAll('div[data-item-type="assignment"]:not([data-should-create-quiz="true"]), div[data-item-type="1"]:not([data-should-create-quiz="true"])'),create_assignment_divs.length>0?create_assignment_divs.forEach(function(e){if(!e.parentElement.parentElement.querySelector(".kami-create-assignment-button"))if(e.dataset.tooltip){var t=document.createElement("div");t.setAttribute("role","menuitem"),t.setAttribute("aria-label","Create Kami Assignment"),t.setAttribute("aria-disabled","false"),t.setAttribute("data-tooltip","Create Kami Assignment"),t.setAttribute("data-item-type","kami-assignment"),t.setAttribute("data-tooltip-position","left"),t.className="XHsn7e hCfBIe UISY8d-Tvm9db bFjUmb-Wvd9Cc kami-create-assignment-button",t.innerHTML=' <div class="HaXdpb"></div><div class="HRp7vf MbhUzd" jsname="ksKsZd"></div><content><content><div class="Ip8zfc" jsaction="JIbuQc:ObNs8b"><div class="kami-create-assignment-icon"></div></div></content></content>',e.parentElement.insertBefore(t,e);var n=document.createElement("span");e.parentElement.insertBefore(n,e.nextSibling),n.outerHTML='<span class="RM9ulf PgfOZ qs41qe" style="bottom: 181.5px;right: 94px;visibility: visible;transform-origin: 100% 50% 0px;transform: translate(0px, 0px);"><span class="R8qYlc"></span><span class="AZnilc">Create Kami assignment</span></span>',t.addEventListener("click",kamiCreateAssignmentButtonListener)}else{kami_button_html='<content class="z80M1 FeRvI kami-create-assignment-button" aria-label="Kami Assignment" role="menuitem" tabindex="-1" jsaction="mouseenter:SKyDAe; mouseleave:xq3APb;" jsname="j7LFlb">\n              <div class="PCdOIb Ce1Y1c" aria-hidden="true">\n                <span class="kami-create-assignment-new-icon" aria-hidden="true"></span>\n              </div>\n              <div class="uyYuVb oJeWuf" data-item-type="assignment">\n                <div class="jO7h3c">Kami assignment</div>\n              </div>\n            </content>',parser.innerHTML=kami_button_html;var a=parser.children[0];parser.removeChild(a),e.parentElement.parentElement.insertBefore(a,e.parentElement.nextSibling),a.addEventListener("click",kamiCreateAssignmentButtonListener)}}):fabMenuObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})};injectClassroomKamiAssignmentButton(),document.body.addEventListener("click",function(e){var t=e.target.closest("a");if(t){var n=t.href;n&&n.includes("https://drive.google.com/open")&&(document.querySelector(".kami-drive-viewer-toolstrip-mid-panel")||previewOpenObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})),n&&n.match(/https?:\/\/classroom\.google\.com.*\/c\/[A-z0-9]+/)&&setTimeout(function(){injectClassroomKamiAssignmentButton()},150)}});var grade_with_kami_enabled="true"===localStorage.getItem("classroom_grade_with_kami_enabled"),match_grading_view=document.location.pathname.match(/\/g\/tg\//);if(match_grading_view){let e,t,n=!1,a=!1;function default_to_setting_src(e){n=!0,e.src=t}function receive_message(t){t.data&&"kamiweb-document-loaded"==t.data.from&&t.origin===KAMI_VIEWER_URL&&(t.data.success?e&&clearTimeout(e):(clearTimeout(e),default_to_setting_src(document.getElementById("material-iframe"))))}function mount_kami_iframe(e){let t=e.parentNode.cloneNode(!0),n=t.childNodes[0];return n.setAttribute("id","kami-iframe"),t.removeAttribute("style"),e.parentNode.parentNode.insertBefore(t,e.parentNode),n}function hide_original_iframe(e){e.style.display="none",e.parentNode.style.display="none",e.src="about:blank"}function addOpenWithKamiButtons(e){e.querySelectorAll(".rTlDl").forEach(function(t){file_url_div=e.querySelector('.clmEye[jsname="Euf9ef"]');var n=file_url_div.getAttribute("data-url").match(/\/open\?id=([A-z0-9-_]+)&authuser=([0-9]+)/);if(n){var a=n[1],i=n[2];jsonData={ids:[a],authuser:i,from:"classroomgradingopenext"};const e=`${KAMI_VIEWER_URL}/web/viewer.html?state=${encodeURIComponent(JSON.stringify(jsonData))}`;parser.innerHTML='<content class="N9wOvf rTlDl" aria-label="Open file in Kami" role="menuitem" tabindex="-1">\n          <div class="Cgh4Db MbhUzd" jsname="ksKsZd"></div>\n          <div class="clmEye"  title="Open in Kami">\n            <div class="MPNyod jTJmQc"> <span class="kami-create-assignment-new-icon" aria-hidden="true"></span>\n            </div>\n          </div>\n        </content>';var r=parser.children[0];parser.removeChild(r),t.parentNode.insertBefore(r,t.nextSibling),r.addEventListener("click",function(t){t.stopImmediatePropagation(),t.preventDefault(),window.open(e,"_blank")}),r.addEventListener("mousedown",function(e){e.stopImmediatePropagation(),e.preventDefault()})}}),e.querySelectorAll(".jEkk3b").forEach(function(t){if(file_url_div=e.querySelector("a"),file_url_div){var n=file_url_div.href.match(/\/open\?id=([A-z0-9-_]+)&authuser=([0-9]+)/);if(n){var a=n[1],i=n[2];jsonData={ids:[a],authuser:i,from:"classroomgradingopenext"};const e=`${KAMI_VIEWER_URL}/web/viewer.html?state=${encodeURIComponent(JSON.stringify(jsonData))}`;var r=`<div role="presentation" class="U26fgb mUbCce fKz7Od jEkk3b" aria-label="Open in Kami" aria-disabled="false" data-tooltip="Open in Kami" data-tooltip-vertical-offset="-12" data-tooltip-horizontal-offset="0">\n          <a class="FKF6mc TpQm9d" href="${e}" target="_blank" aria-label="Open in Kami">\n            <div class="VTBa7b MbhUzd" jsname="ksKsZd"></div>\n            <content class="xjKiLb">\n              <span style="top: -12px">\n                  <div class="kami-create-assignment-new-icon" aria-hidden="true"></div>\n              </span>\n            </content>\n          </a>\n        </div>`;parser.innerHTML=r;var o=parser.children[0];parser.removeChild(o),t.parentNode.parentNode.appendChild(o),o.addEventListener("click",function(t){t.stopImmediatePropagation(),t.preventDefault(),window.open(e,"_blank")}),o.addEventListener("mousedown",function(e){e.stopImmediatePropagation(),e.preventDefault()})}}})}function processNewKamiDoc(i,r,o){t=`${KAMI_VIEWER_URL}/web/viewer.html?state=${encodeURIComponent(JSON.stringify(o))}`,n?r.src=t:(r?a?r.src=t:(r.contentWindow.postMessage(o,KAMI_VIEWER_URL),e=window.setTimeout(default_to_setting_src.bind(null,r),4e3)):(r=mount_kami_iframe(i)).src=t,a=!1,hide_original_iframe(i))}function processNewNonPDF(e,t){t||(t=mount_kami_iframe(e)),t.src=e.src,a=!0,hide_original_iframe(e)}function processPreviewIframe(t){let n=t.src.match(/\/file\/d\/([A-z0-9-_]+)\/grading\?authuser=.+/),a=document.getElementById("kami-iframe");if(clearTimeout(e),n){if(document.querySelector("#grade_with_kami_wrapper").style.display="flex",grade_with_kami_enabled){processNewKamiDoc(t,a,{ids:[n[1]],from:"classroomgradingview"})}}else document.querySelector("#grade_with_kami_wrapper").style.display="none",grade_with_kami_enabled&&processNewNonPDF(t,a)}window.addEventListener("message",receive_message);let i=new MutationObserver(function(e){e.forEach(function(e){if(e.addedNodes)for(var t=0;t<e.addedNodes.length;t++){var n=e.addedNodes[t];"material-iframe"===n.id?processPreviewIframe(n):(n.classList&&n.classList.contains("cNxwhc")&&n.classList.contains("MPNyod")||n.firstElementChild&&n.firstElementChild.classList.contains("cNxwhc")&&n.firstElementChild.classList.contains("MPNyod"))&&addOpenWithKamiButtons(n)}})});const r=document.querySelector(".cNxwhc.MPNyod");r&&addOpenWithKamiButtons(r),i.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1});const o=document.querySelector(".D4ueke");if(o){const e=`<div style="display: none;" class="D4ueke" id="grade_with_kami_wrapper">\n      <label>Grade with Kami <input type="checkbox" name="grade_with_kami" id="grade_with_kami_checkbox" ${grade_with_kami_enabled?"checked":""}></input></label>\n    </div>`;parser.innerHTML=e;var grade_with_kami_checkbox=parser.children[0];parser.removeChild(grade_with_kami_checkbox),o.parentNode.insertBefore(grade_with_kami_checkbox,o.nextSibling),document.querySelector("#grade_with_kami_checkbox").addEventListener("change",function(e){localStorage.setItem("classroom_grade_with_kami_enabled",e.target.checked),window.location.reload()})}const s=document.getElementById("material-iframe");s&&processPreviewIframe(s)}