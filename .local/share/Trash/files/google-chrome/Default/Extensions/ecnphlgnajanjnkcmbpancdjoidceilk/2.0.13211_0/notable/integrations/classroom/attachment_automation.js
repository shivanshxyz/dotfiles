const PICKER_ORIGIN="https://drive.google.com";var messagesToPicker=[],messagesToViewer=[],observers={},pickerWindow=null,kamiViewerWindow=null,yourWorkDiv=null,progress=null;function coverPageWithOverlay(){let e=document.createElement("div");e.classList.add("kami-attachment-overlay");let t=document.createElement("div");t.classList.add("kami-attachment-overlay-card");let o=document.createElement("p");o.innerHTML="Kami is attaching your file";let s=document.createElement("p");s.innerHTML="Please keep this window on top";let n=document.createElement("div");n.classList.add("linear-progress");let r=document.createElement("div");r.classList.add("bar"),r.classList.add("bar1");let i=document.createElement("div");i.classList.add("bar"),i.classList.add("bar2"),n.appendChild(r),n.appendChild(i),t.appendChild(n),t.appendChild(o),t.appendChild(s),e.appendChild(t),applyOverlay=(()=>{document.body.appendChild(e),document.body.style.overflow="hidden"}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",applyOverlay):applyOverlay()}function attachDriveFileToAssignment(e){coverPageWithOverlay(),observers.attachButton=new DeadlinedObserver("attachButton",15e3,function(e){for(mutation of e)if(mutation.addedNodes)for(node of mutation.addedNodes){let e=node.nextElementSibling;if(!e)continue;if("fJ1Vac"!==e.className)continue;let t=document.querySelector(".U26fgb.REtOWc");if(t)return observers.attachButton.conclude(),progress.increaseStep(),observers.dropdown.observe(document.body,{subtree:!0,attributes:!0}),void t.click()}}),observers.dropdown=new DeadlinedObserver("dropdown",5e3,function(e){for(mutation of e){if(!mutation.addedNodes)return;let e=document.querySelector(".z80M1.FeRvI");if(!e)return;return observers.dropdown.conclude(),progress.increaseStep(),observers.picker.observe(document.body,{childList:!0,subtree:!0}),e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),void e.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window}))}}),observers.picker=new DeadlinedObserver("picker",15e3,function(t){t.forEach(function(t){if(t.addedNodes)for(node of t.addedNodes){if("IFRAME"!==node.tagName)continue;let t=node.dataset.postorigin;if(!t||!/https:\/\/drive\.google\.com\/picker/.test(t))continue;let o=/rpctoken=([a-zA-Z0-9]+?)($|&)/.exec(t),s=null;if(o&&(s=o[1]),s)return pickerWindow=node.contentWindow,observers.picker.conclude(),progress.increaseStep(),yourWorkDiv=document.querySelector(".asCVDb.BiaLW"),observers.errorCard.observe(document.body,{childList:!0,subtree:!0,attributes:!0}),observers.attachmentItem.observe(yourWorkDiv,{childList:!0,subtree:!0,attributes:!0}),void messagesToPicker.push({kamiMessage:{type:"command",command:"pick_file",driveFileId:e,rpcToken:o[1]}})}})}),observers.attachmentItem=new DeadlinedObserver("attachmentItem",2e4,function(t){t.forEach(function(t){if(t.addedNodes)for(node of t.addedNodes){if(!node.innerHTML.includes(e))continue;return observers.attachmentItem.conclude(),progress.increaseStep(),observers.errorCard.disconnect(),void sendMessageToViewer({kamiMessage:{type:"notification",notificationCode:"attachment_success",fileId:e}})}})}),observers.errorCard=new MutationObserver(function(e){e.forEach(function(e){if(e.addedNodes)for(node of e.addedNodes)if(node.className&&"string"==typeof node.className&&node.className.match(/LhKRUe.+JKIkqc/)){observers.errorCard.disconnect(),observers.attachmentItem.conclude();let e=null;return node.children.length&&(innerText=node.children[0].innerText),e=innerText&&innerText.length>1?innerText:"Unknown error: Could not get message from error card",void sendMessageToViewer({kamiMessage:{type:"notification",notificationCode:"attachment_error",error:innerText}})}})}),observers.attachButton.observe(document.body,{childList:!0,subtree:!0})}function sendMessageToViewer(e){kamiViewerWindow?kamiViewerWindow.postMessage(e,KAMI_VIEWER_URL):messagesToViewer.push(e)}function init(){window.addEventListener("message",e=>{if(kamiMessage=e.data.kamiMessage,kamiMessage)switch(e.origin){case KAMI_VIEWER_URL:for(kamiViewerWindow=e.source;messagesToViewer.length;)sendMessageToViewer(messagesToViewer.shift());"ping"==kamiMessage.type&&sendMessageToViewer({kamiMessage:{type:"pong"}});break;case PICKER_ORIGIN:if(kamiMessage=e.data.kamiMessage,"script_ready"==kamiMessage.type)for(;messagesToPicker.length;)pickerWindow.postMessage(messagesToPicker.shift(),PICKER_ORIGIN)}}),progress={currentStep:1,increaseStep:()=>{progress.currentStep++,sendMessageToViewer({kamiMessage:{type:"notification",notificationCode:"attachment_progress",currentStep:progress.currentStep,totalSteps:progress.totalSteps}})},totalSteps:5};let e=new URLSearchParams(window.location.search).get("attachFileId");e?attachDriveFileToAssignment(e):sendMessageToViewer({kamiMessage:{type:"notification",notificationCode:"no_attach_id_received"}})}class DeadlinedObserver extends MutationObserver{constructor(e,t,o){super(o),this.name=e,this.timeoutMilliseconds=t}observe(...e){super.observe(...e),this.timeout=setTimeout(()=>{sendMessageToViewer({kamiMessage:{type:"notification",notificationCode:"attachment_error",error:`[${this.name}] observer timed out`}})},this.timeoutMilliseconds)}conclude(){super.disconnect(),clearTimeout(this.timeout)}}init();