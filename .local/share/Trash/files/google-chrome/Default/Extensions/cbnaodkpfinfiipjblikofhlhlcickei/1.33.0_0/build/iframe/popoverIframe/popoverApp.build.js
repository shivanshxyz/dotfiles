var popoverApp=angular.module("popoverApp",["popoverCtrl","contentScript","RecursionHelper"]).directive("ngEnter",function(){return function(t,e,o){e.bind("keydown",function(e){13===e.which&&(t.$apply(function(){t.$eval(o.ngEnter,{e:e})}),e.preventDefault())})}}).directive("contenteditable",function(){return{restrict:"A",require:"ngModel",link:function(e,t,o,i){function n(){i.$setViewValue(t.html())}i.$render=function(){t.html(i.$viewValue||"")},t.bind("blur keyup change",function(){e.$apply(n)})}}}).directive("autofocus",["$timeout",function(o){return{restrict:"A",scope:{highlightId:"="},link:function(e,i){e.$watch("highlightId",function(e,t){e&&o(function(){var e=i[0];e.focus();var t=document.createRange();t.selectNodeContents(e),t.collapse(!1);var o=window.getSelection();o.removeAllRanges(),o.addRange(t)})},!0)}}}]).run(["$rootScope","contentScript",function(e,t){t.init()}]),popoverCtrl=angular.module("popoverCtrl",[]);popoverCtrl.controller("popoverCtrl",["$rootScope","$scope","contentScript",function(s,i,n){i.editingNote=null,i.hoveringNote=!1,i._AUTO_SAVE_DEBOUCE=2e3,i.editingFolder={id:null,title:null,colorTags:["","","","",""],colorCodes:null},i.editingColor=null,i.previousColorCode=null,i.highlightMode=!0,i._actionGateway=function(){return s._states.user?!!s._states.connectionStatus||(n.postWindowMessage({id:"PROMPT_NETWORK"}),!1):(n.postWindowMessage({id:"PROMPT_LOGIN"}),!1)},i._getHighlightCount=function(){var e=0,t=s._states.activeFolder;if(t&&t.websites)for(var o=Object.keys(t.websites),i=0;i<o.length;i++){var n=t.websites[i];if(n.highlights)e+=Object.keys(n.highlights).length}return e},i.clickedCircleListener=function(e){if(i._actionGateway()){if(s._states.user.isAnonymous&&s._states.activeFolder&&22<i._getHighlightCount())return n.postWindowMessage({id:"LOG_EVENT",event:"ANONYMOUS_BLOCK",meta:{reason:"NUMBER_HIGHLIGHTS"}}),void n.postWindowMessage({id:"SHOW_UPGRADE_ANONYMOUS_MODAL"});if(e!==s._states.lightedUpCircle)if(!s._states.subscription&&s._states.onboarding&&s._states.onboarding.colorLimitReferralTest&&e>s._states.onboarding.colorLimitReferralTest+1)s._states.user.isAnonymous?(n.postWindowMessage({id:"LOG_EVENT",event:"ANONYMOUS_BLOCK",meta:{reason:"COLOR_LIMIT_EXCEED"}}),n.postWindowMessage({id:"SHOW_UPGRADE_ANONYMOUS_MODAL"})):(n.postWindowMessage({id:"COLOR_LIMIT_EXCEED_REFERRAL"}),n.postWindowMessage({id:"LOG_EVENT",event:"CHOOSE_COLOR_UNPAID",meta:{source:"POPOVER"}}));else{var t={colorNum:e};null===s._states.lightedUpCircle?(t.id="POP_CREATE_HIGHLIGHT",t.colorCode=s._states.colorCodes[e-1]):t.id="POP_UPDATE_HIGHLIGHT",n.postWindowMessage(t)}else n.postWindowMessage({id:"POP_DELETE_HIGHLIGHT"})}},i.clickedActiveFolderListener=function(){i._actionGateway()&&(n.postWindowMessage({id:"LOG_EVENT",event:"POP_CLICKED_ACTIVE_FOLDER"}),n.postWindowMessage({id:"POP_CLICKED_ACTIVE_FOLDER"}))},i.clickedDropdownItemListener=function(e,t){e.stopPropagation(),i._actionGateway()&&("new-collection"===t?n.postWindowMessage({id:"POP_CREATE_FOLDER"}):n.postWindowMessage({id:"POP_SWITCH_FOLDER",folderId:t}))},i.getCircleCategoryPointerStyle=function(e){var t={};switch(e){case 5:case 10:t.right="0";break;case 4:case 9:t.right="30px"}return t},i.clickedSetting=function(){n.postWindowMessage({id:"LOG_EVENT",event:"POP_TOGGLE_SETTING",meta:{mode:!0}}),n.postWindowMessage({id:"POP_TOGGLE_SETTING",show:!0}),s._states.user&&s._states.activeFolder?i.editingFolder={id:s._states.activeFolder.folderId,title:s._states.activeFolder.title,colorTags:s._states.activeFolder.colorTags?s._states.activeFolder.colorTags.slice():["","","","",""],colorCodes:s._states.colorCodes.slice()}:i.editingFolder={id:"",title:"",colorTags:["","","","",""],colorCodes:s._states.colorCodes.slice()}},i.hideSetting=function(){n.postWindowMessage({id:"LOG_EVENT",event:"POP_TOGGLE_SETTING",meta:{mode:!1}}),n.postWindowMessage({id:"POP_TOGGLE_SETTING",show:!1}),i.editingFolder={id:null,title:null,colorTags:["","","","",""],colorCodes:null}},i.onSaveSetting=function(){i._actionGateway()&&(i.saveFolderEdit(),i.highlightMode||(i.highlightMode=!0,i.saveHighlightMode()),n.postWindowMessage({id:"POP_TOGGLE_SETTING",show:!1}))},i.saveFolderEdit=function(){n.postWindowMessage({id:"LOG_EVENT",event:"POP_EDIT_FOLDER"}),n.postWindowMessage({id:"EDIT_FOLDER",folderId:i.editingFolder.id,title:i.editingFolder.title,colorTags:i.editingFolder.colorTags,colorCodes:i.editingFolder.colorCodes}),i.editingFolder={id:null,title:null,colorTags:["","","","",""],colorCodes:null}},i.toggleEditingColors=function(e){n.postWindowMessage({id:"LOG_EVENT",event:"EDIT_COLOR",meta:{source:"POPOVER"}}),i._actionGateway()&&(null===e||s._states.subscription?(n.postWindowMessage({id:"LOG_EVENT",event:"EDIT_COLOR_SUCCESS",meta:{source:"POPOVER"}}),i.editingColor=e,i.previousColorCode=e?i.editingFolder.colorCodes[e]:null):(n.postWindowMessage({id:"LOG_EVENT",event:"EDIT_COLOR_UNPAID",meta:{source:"POPOVER"}}),n.postWindowMessage({id:"SHOW_PAYMENT_MODEL"})))},i.deleteHighlightColor=function(o){if(i._actionGateway()){n.postWindowMessage({id:"LOG_EVENT",event:"DELETE_COLOR",meta:{source:"POPOVER"}});var e=s._states.activeFolder.websites.filter(function(t){return 0<Object.keys(t.highlights).filter(function(e){return t.highlights[e].colorNum===o}).length}).length;0<e?alert("Cannot delete this color! "+e+" highlights is using that in this collection."):i.editingFolder.colorCodes[o-1]=null}},i.getNextColorNum=function(e){for(var t=0;t<e.length;t++)if(!e[t])return t+1;return e.length+1},i.addToHighlightColors=function(){if(n.postWindowMessage({id:"LOG_EVENT",event:"ADD_COLOR",meta:{source:"POPOVER"}}),i._actionGateway())if(s._states.subscription){n.postWindowMessage({id:"LOG_EVENT",event:"ADD_COLOR_SUCCESS",meta:{source:"POPOVER"}});var e=i.getNextColorNum(i.editingFolder.colorCodes);i.editingFolder.colorCodes[e-1]=s._states.COLOR_PROFILE[e-1]}else n.postWindowMessage({id:"SHOW_PAYMENT_MODEL"}),n.postWindowMessage({id:"LOG_EVENT",event:"ADD_COLOR_UNPAID",meta:{source:"POPOVER"}})},i.toggleHighlightButton=function(){i.highlightMode=!i.highlightMode},i.saveHighlightMode=function(){n.postWindowMessage({id:"LOG_EVENT",event:"TOGGLE_HIGHLIGHT_MODE",meta:{source:"POPOVER",mode:!1}}),n.postWindowMessage({id:"HIGHLIGHT_MODE_SETTINGS",highlightModeSettings:{pdf:s._states.workspace.extensionHighlightModeSettings.pdf,highlighter:!1}})},i.shadeColor=function(e,t){var o=parseInt(e.slice(1),16),i=t<0?0:255,n=t<0?-1*t:t,s=o>>16,r=o>>8&255,a=255&o;return"#"+(16777216+65536*(Math.round((i-s)*n)+s)+256*(Math.round((i-r)*n)+r)+(Math.round((i-a)*n)+a)).toString(16).slice(1)},i._autoSave=gistDebounce(i._AUTO_SAVE_DEBOUCE,function(){s.saveNow()}.bind(this)),s.saveNow=function(){if(s.noteSavingState===s.SAVING){n.postWindowMessage({id:"LOG_EVENT",event:"POP_EDIT_NOTE"});var e=s.editingNote.isEmpty?null:s._states.note;n.postWindowMessage({id:"EDIT_NOTE",folderId:s.editingNote.folderId,highlightId:s.editingNote.highlightId,note:e}),s.noteSavingState=s.SAVED,s.$apply()}},i.saveHighlightNote=function(e){s.editingNote={folderId:s._states.activeFolder.folderId,highlightId:s._states.highlightId,isEmpty:e&&e.target&&0===e.target.innerText.replace(/\s/g,"").length},s.noteSavingState=s.SAVING,i._autoSave()}}]);var contentScriptFact=angular.module("contentScript",[]);contentScriptFact.factory("contentScript",["$rootScope","$timeout",function(o,e){"use strict";var t={init:function(){o._states={},o.SAVING="saving...",o.SAVED="saved",o.noteSavingState=o.SAVED,window.addEventListener("message",t._messageListener)},postWindowMessage:function(e){e.source="Popover Iframe",window.parent.postMessage(e,"*")},_messageListener:function(e){var t=e.data;switch(t.id){case"POPOVER_IFRAME_SYNC_STATES":o.noteSavingState===o.SAVING&&(t.states.note=o._states.note,o.saveNow()),o._states=t.states;break;default:return!0}o.$apply()},_shadeColor:function(e,t){var o=parseInt(e.slice(1),16),i=t<0?0:255,n=t<0?-1*t:t,s=o>>16,r=o>>8&255,a=255&o;return"#"+(16777216+65536*(Math.round((i-s)*n)+s)+256*(Math.round((i-r)*n)+r)+(Math.round((i-a)*n)+a)).toString(16).slice(1)}};return t}]),angular.module("RecursionHelper",[]).factory("RecursionHelper",["$compile",function(s){return{compile:function(e,o){angular.isFunction(o)&&(o={post:o});var i,n=e.contents().remove();return{pre:o&&o.pre?o.pre:null,post:function(e,t){i||(i=s(n)),i(e,function(e){t.append(e)}),o&&o.post&&o.post.apply(null,arguments)}}}}}]);